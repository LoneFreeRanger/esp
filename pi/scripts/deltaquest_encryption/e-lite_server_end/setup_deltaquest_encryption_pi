# https://charlesreid1.com/wiki/RaspberryPi/SSH_Stunnel
# https://blog.thesysadmins.co.uk/using-stunnel-to-encrypt-unsecure-connections.html
# This script is to run on an e-lite server in order enable stunnel ssh keys passwordless login


clear
echo "Checking for key stunnel-deltaquest.pem within /tmp....."
sleep 5

CERT_PRESENT=$(find /tmp -name stunnel-deltaquest.pem | wc -l)
if [ $CERT_PRESENT -ge 1 ]
then
echo "Key is present. Continuing...."
else
echo "No key is present. Now exiting. No changes have been made."
echo ""
echo "Please place the deltaquest stunnel encryption key (stunnel-deltaquest.pem) within /tmp on this e-lite server."
exit
fi


###############


# Enable Ipv4 forwarding at boot
sed -i '20 a echo 1 > /proc/sys/net/ipv4/ip_forward' /etc/rc.local

# Install stunnel package if not already installed
sudo apt-get install -y stunnel

cd /etc/stunnel/

# How the key was originally created on the e-lite server
# openssl genrsa -out key.pem 2048
# Generate a Self-Signed Certificate
# openssl req -new -x509 -key key.pem -out cert.pem -days 14600

# Copy the keys into stunnel configuration
# cat key.pem cert.pem >> /etc/stunnel/stunnel-deltaquest.pem
chmod 400 /etc/stunnel/stunnel-deltaquest.pem

# Create stunnel logs directory if not already present
mkdir -p /u/logs/stunnel/

# Get the Stunnel config file and put in place
/usr/bin/wget --no-check-certificate 'https://raw.githubusercontent.com/LoneFreeRanger/esp/main/pi/scripts/deltaquest_encryption/e-lite_server_end/stunnel.conf' -O /etc/stunnel/stunnel.conf

# Start the stunnel service
/etc/init.d/stunnel4 restart

# Add default hosts file enteries
echo "" >> /etc/hosts
echo "# DeltaQuest IP Door Entry Boxes" >> /etc/hosts
echo "# If configuring new units, make sure the port is not already in-use on the server" >> /etc/hosts
echo "0.0.0.0 deltaquest1   # Port 10001" >> /etc/hosts
echo "0.0.0.0 deltaquest2   # Port 10002" >> /etc/hosts
echo "0.0.0.0 deltaquest3   # Port 10003" >> /etc/hosts
echo "0.0.0.0 deltaquest4   # Port 10004" >> /etc/hosts
echo "0.0.0.0 deltaquest5   # Port 10005" >> /etc/hosts
echo "0.0.0.0 deltaquest6   # Port 10006" >> /etc/hosts
echo "0.0.0.0 deltaquest7   # Port 10007" >> /etc/hosts
echo "0.0.0.0 deltaquest8   # Port 10008" >> /etc/hosts
echo "0.0.0.0 deltaquest9   # Port 10009" >> /etc/hosts
echo "0.0.0.0 deltaquest10  # Port 10010" >> /etc/hosts
echo "0.0.0.0 deltaquest11  # Port 10011" >> /etc/hosts
echo "0.0.0.0 deltaquest12  # Port 10012" >> /etc/hosts
echo "0.0.0.0 deltaquest13  # Port 10013" >> /etc/hosts
echo "0.0.0.0 deltaquest14  # Port 10014" >> /etc/hosts
echo "0.0.0.0 deltaquest15  # Port 10015" >> /etc/hosts
echo "0.0.0.0 deltaquest16  # Port 10016" >> /etc/hosts
echo "0.0.0.0 deltaquest17  # Port 10017" >> /etc/hosts
echo "0.0.0.0 deltaquest18  # Port 10018" >> /etc/hosts
echo "0.0.0.0 deltaquest19  # Port 10019" >> /etc/hosts
echo "0.0.0.0 deltaquest20  # Port 10020" >> /etc/hosts
echo "0.0.0.0 deltaquest21  # Port 10021" >> /etc/hosts
echo "0.0.0.0 deltaquest22  # Port 10022" >> /etc/hosts
echo "0.0.0.0 deltaquest23  # Port 10023" >> /etc/hosts
echo "0.0.0.0 deltaquest24  # Port 10024" >> /etc/hosts
echo "0.0.0.0 deltaquest25  # Port 10025" >> /etc/hosts
echo "0.0.0.0 deltaquest26  # Port 10026" >> /etc/hosts
echo "0.0.0.0 deltaquest27  # Port 10027" >> /etc/hosts
echo "0.0.0.0 deltaquest28  # Port 10028" >> /etc/hosts
echo "0.0.0.0 deltaquest29  # Port 10029" >> /etc/hosts
echo "0.0.0.0 deltaquest30  # Port 10030" >> /etc/hosts
echo "0.0.0.0 deltaquest31  # Port 10031" >> /etc/hosts
echo "0.0.0.0 deltaquest32  # Port 10032" >> /etc/hosts
echo "0.0.0.0 deltaquest33  # Port 10033" >> /etc/hosts
echo "0.0.0.0 deltaquest34  # Port 10034" >> /etc/hosts
echo "0.0.0.0 deltaquest35  # Port 10035" >> /etc/hosts
echo "0.0.0.0 deltaquest36  # Port 10036" >> /etc/hosts
echo "0.0.0.0 deltaquest37  # Port 10037" >> /etc/hosts
echo "0.0.0.0 deltaquest38  # Port 10038" >> /etc/hosts
echo "0.0.0.0 deltaquest39  # Port 10039" >> /etc/hosts
echo "0.0.0.0 deltaquest40  # Port 10040" >> /etc/hosts
echo "0.0.0.0 deltaquest41  # Port 10041" >> /etc/hosts
echo "0.0.0.0 deltaquest42  # Port 10042" >> /etc/hosts
echo "0.0.0.0 deltaquest43  # Port 10043" >> /etc/hosts
echo "0.0.0.0 deltaquest44  # Port 10044" >> /etc/hosts
echo "0.0.0.0 deltaquest45  # Port 10045" >> /etc/hosts
echo "0.0.0.0 deltaquest46  # Port 10046" >> /etc/hosts
echo "0.0.0.0 deltaquest47  # Port 10047" >> /etc/hosts
echo "0.0.0.0 deltaquest48  # Port 10048" >> /etc/hosts
echo "0.0.0.0 deltaquest49  # Port 10049" >> /etc/hosts
echo "0.0.0.0 deltaquest50  # Port 10050" >> /etc/hosts





# Enable firewall rules ?????
 











# Add to the bottom of /etc/iptables.firewall.rules file. This permits the e-lite server to forward the connection into the e-lite server
*nat
:PREROUTING ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
# Nortech DeltaQuest Ports (change the 98.98.98.98 to the applicable Nortech DeltaQuest units local IPs)
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1001 -j DNAT --to-destination 98.98.98.98:10001
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1002 -j DNAT --to-destination 98.98.98.98:10002
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1003 -j DNAT --to-destination 98.98.98.98:10003
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1004 -j DNAT --to-destination 98.98.98.98:10004
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1005 -j DNAT --to-destination 98.98.98.98:10005
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1006 -j DNAT --to-destination 98.98.98.98:10006
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1007 -j DNAT --to-destination 98.98.98.98:10007
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1008 -j DNAT --to-destination 98.98.98.98:10008
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1009 -j DNAT --to-destination 98.98.98.98:10009
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1010 -j DNAT --to-destination 98.98.98.98:10010
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1011 -j DNAT --to-destination 98.98.98.98:10011
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1012 -j DNAT --to-destination 98.98.98.98:10012
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1013 -j DNAT --to-destination 98.98.98.98:10013
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1014 -j DNAT --to-destination 98.98.98.98:10014
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1015 -j DNAT --to-destination 98.98.98.98:10015
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1016 -j DNAT --to-destination 98.98.98.98:10016
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1017 -j DNAT --to-destination 98.98.98.98:10017
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1018 -j DNAT --to-destination 98.98.98.98:10018
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1019 -j DNAT --to-destination 98.98.98.98:10019
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1020 -j DNAT --to-destination 98.98.98.98:10020
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1021 -j DNAT --to-destination 98.98.98.98:10021
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1022 -j DNAT --to-destination 98.98.98.98:10022
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1023 -j DNAT --to-destination 98.98.98.98:10023
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1024 -j DNAT --to-destination 98.98.98.98:10024
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1025 -j DNAT --to-destination 98.98.98.98:10025
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1026 -j DNAT --to-destination 98.98.98.98:10026
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1027 -j DNAT --to-destination 98.98.98.98:10027
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1028 -j DNAT --to-destination 98.98.98.98:10028
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1029 -j DNAT --to-destination 98.98.98.98:10029
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1030 -j DNAT --to-destination 98.98.98.98:10030
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1031 -j DNAT --to-destination 98.98.98.98:10031
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1032 -j DNAT --to-destination 98.98.98.98:10032
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1033 -j DNAT --to-destination 98.98.98.98:10033
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1034 -j DNAT --to-destination 98.98.98.98:10034
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1035 -j DNAT --to-destination 98.98.98.98:10035
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1036 -j DNAT --to-destination 98.98.98.98:10036
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1037 -j DNAT --to-destination 98.98.98.98:10037
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1038 -j DNAT --to-destination 98.98.98.98:10038
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1039 -j DNAT --to-destination 98.98.98.98:10039
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1040 -j DNAT --to-destination 98.98.98.98:10040
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1041 -j DNAT --to-destination 98.98.98.98:10041
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1042 -j DNAT --to-destination 98.98.98.98:10042
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1043 -j DNAT --to-destination 98.98.98.98:10043
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1044 -j DNAT --to-destination 98.98.98.98:10044
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1045 -j DNAT --to-destination 98.98.98.98:10045
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1046 -j DNAT --to-destination 98.98.98.98:10046
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1047 -j DNAT --to-destination 98.98.98.98:10047
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1048 -j DNAT --to-destination 98.98.98.98:10048
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1049 -j DNAT --to-destination 98.98.98.98:10049
-A PREROUTING -s 127.0.0.1 -p tcp --dport 1050 -j DNAT --to-destination 98.98.98.98:10050
-A POSTROUTING -j MASQUERADE
COMMIT






THESE COMMANDS ALSO WORK OUTSIDE OF iptables FILE:
# Add rules to firewall to forward Nortech Ports to Nortech Boxes
iptables -t nat -A PREROUTING -p tcp --dport 1001 -j DNAT --to-destination [NORTECH_IP]:1001
iptables -t nat -A POSTROUTING -j MASQUERADE
