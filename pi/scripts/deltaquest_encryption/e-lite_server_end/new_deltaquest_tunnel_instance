
clear
echo "Checking if stunnel is installed....."
sleep 3
STUNNEL_PRESENT=$(rpm -qa | grep stunnel | wc -l)
if [ $CERT_PRESENT -ge 1 ]
then
echo "Stunnel is installed. Continuing...."
sleep 2
else
echo "Stunnel is not installed. No changes have been made."
echo ""
echo "Please make sure 'setup_deltaquest_encryption_linux' is run first in  the deltaquest stunnel encryption key stunnel-deltaquest.pem within /tmp on this e-lite server."
exit
fi

clear
echo "Checking to see if certificate seems valid...."
VALID_CERT=$(cat /tmp/stunnel-deltaquest.pem | grep "O2qB3Zrart32XDAPB" | wc -l)
if [ $VALID_CERT -ge 1 ]
then
echo "Certificate appears valid. Continuing...."
sleep 2
else
echo "Certificate stunnel-deltaquest.pem within /tmp does not seem valid. Now exiting. No changes have been made."
echo ""
echo "Please place the correct deltaquest stunnel encryption key (stunnel-deltaquest.pem) within /tmp on this e-lite server."
exit
fi


clear
echo "What is the address code for site?"
read addresscodeinput
echo $addresscodeinput > /tmp/addresscode
echo ""
echo "--------------------------------------------------"
echo ""
echo "What is the free deltaquest port number that can be used by this server?
echo "This should be that of what is configured on the remote deltaquest box?"
read portidinput
echo $portidinput > /tmp/portid

PORTCHECK=$(netstat -a | grep $(/tmp/portid) | wc -l)
IF [ $PORTCHECK -ge 1 ]
then
echo "There is an error. The port number supplied ($cat /tmp/portid) is already in-use on this server. It cannot be used again."
echo ""
echo "You will need to use a port in the range of 10001 - 10050 that is not in 
echo "use on this server and one that is configured on the remote DeltaQuest box you are trying to setup a connection to." 
exit
else
echo "Continuing..."
fi

# Get the default stunnel ESP config file
/usr/bin/wget --no-check-certificate 'https://raw.githubusercontent.com/LoneFreeRanger/esp/main/pi/scripts/deltaquest_encryption/linux_server_end/deltaquest-%5Bsiteid%5D-%5Bport%5D-tunnel' -O /u/tunnels/deltaquest-[siteid]-[port]-tunnel

# Rename the config file with previously supplied port and site ID
mv /u/tunnels/deltaquest-[siteid]-[port]-tunnel /u/tunnels/deltaquest-$(cat /tmp/addresscode)-$(cat /tmp/portid)-tunnel

#############################################
