mkdir -p /var/log/stunnel
mkdir -p /var/run/stunnel

# get the stunnel-deltaquest.service file and place in /etc/systemd/system
/usr/bin/wget --no-check-certificate 'https://raw.githubusercontent.com/LoneFreeRanger/esp/main/pi/scripts/deltaquest_encryption/linux_server_end/stunnel-deltaquest.service' -O /etc/systemd/system/stunnel-deltaquest.service

# Set perms on the service file, load into kernel and enable on boot
chmod 777 /etc/systemd/system/stunnel-deltaquest.service
systemctl daemon-reload
systemctl enable stunnel-deltaquest.service

# Create stunnel config holding directory if not already present and set perms
mkdir -p /u/tunnels
chmod -R 777 /u/tunnels

# Create a deltaquest user that will use the tunnel to the e-lite server
useradd -g50 -s /bin/bash -d /home/deltaquest deltaquest


# Put in place the ssh keys
cp -rf /srv/files/customer_deltaquest_user_ssh_key.tar.gz /home/deltaquest/
cd /home/deltaquest/
tar xfz customer_deltaquest_user_ssh_key.tar.gz
chmod 700 .ssh
chown deltaquest:deltaquest .ssh
cd .ssh
chmod 600 authorized_keys
chown deltaquest:sites authorized_keys
