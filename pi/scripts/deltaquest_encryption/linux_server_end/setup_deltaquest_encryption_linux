# Check for the certifcate being pesent

clear
echo "Checking for key stunnel-deltaquest.pem within /tmp....."
sleep 3
CERT_PRESENT=$(find /tmp -name stunnel-deltaquest.pem | wc -l)
if [ $CERT_PRESENT -ge 1 ]
then
echo "Key is present. Continuing...."
sleep 2
else
echo "No key is present. Now exiting. No changes have been made."
echo ""
echo "Please place the deltaquest stunnel encryption key stunnel-deltaquest.pem within /tmp on this e-lite server."
exit
fi

clear
echo "Checking to see if certificate seems valid...."
VALID_CERT=$(cat /tmp/stunnel-deltaquest.pem | grep "O2qB3Zrart32XDAPB" | wc -l)
if [ $VALID_CERT -ge 1 ]
then
echo "Certificate appears valid. Continuing...."
sleep 2
else
echo "Certificate stunnel-deltaquest.pem within /tmp does not seem valid. Now exiting. No changes have been made."
echo ""
echo "Please place the correct deltaquest stunnel encryption key (stunnel-deltaquest.pem) within /tmp on this e-lite server."
exit
fi

# Install stunnel if not already installed
yum install -y stunnel

# Copy into place the rsa key
cp /tmp/stunnel-deltaquest.pem /etc/stunnel
chmod 600 /etc/stunnel/stunnel-deltaquest.pem

# Setup directories if not already present
mkdir -p /var/log/stunnel/
mkdir -p /var/run/stunnel/
mkdir -p /var/run/stunnel4/
mkdir -p /u/tunnels/
chmod -R 777 /u/tunnels

clear
echo "DeltaQuest encryption has now been setup (but with no tunnels configured)"
echo ""
echo "Should a new tunnel be needed, please run seperate script '/u/espbin/new_deltaquest_tunnel_instance' "
echo ""





