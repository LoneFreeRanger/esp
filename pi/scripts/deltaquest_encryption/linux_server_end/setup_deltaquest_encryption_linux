# Check for the certifcate being pesent

clear
echo "Checking for key stunnel-deltaquest.pem within /tmp....."
sleep 3
CERT_PRESENT=$(find /tmp -name stunnel-deltaquest.pem | wc -l)
if [ $CERT_PRESENT -ge 1 ]
then
echo "Key is present. Continuing...."
sleep 2
else
echo "No key is present. Now exiting. No changes have been made."
echo ""
echo "Please place the deltaquest stunnel encryption key stunnel-deltaquest.pem within /tmp on this e-lite server."
exit
fi

clear
echo "Checking to see if certificate seems valid...."
VALID_CERT=$(cat /tmp/stunnel-deltaquest.pem | grep "O2qB3Zrart32XDAPB" | wc -l)
if [ $VALID_CERT -ge 1 ]
then
echo "Certificate appears valid. Continuing...."
sleep 2
else
echo "Certificate stunnel-deltaquest.pem within /tmp does not seem valid. Now exiting. No changes have been made."
echo ""
echo "Please place the correct deltaquest stunnel encryption key (stunnel-deltaquest.pem) within /tmp on this e-lite server."
exit
fi

# Install stunnel if not already installed
yum install -y stunnel

# Copy into place the rsa key
cp /tmp/stunnel-deltaquest.pem /etc/stunnel

# Setup directories if not already present
mkdir -p /var/log/stunnel/
mkdir -p /var/run/stunnel/
mkdir -p /var/run/stunnel4/
mkdir -p /u/tunnels/
chmod -R 777 /u/tunnels

# Get the default stunnel ESP config file
/usr/bin/wget --no-check-certificate 'https://raw.githubusercontent.com/LoneFreeRanger/esp/main/pi/scripts/deltaquest_encryption/linux_server_end/deltaquest-%5Bsiteid%5D-%5Bport%5D-tunnel' -O /u/tunnels/deltaquest-[siteid]-[port]-tunnel

clear
echo "What is the address code for site?"
read addresscodeinput
echo $addresscodeinput > /tmp/addresscode
echo ""
echo "--------------------------------------------------"
echo ""
echo "What is the free port number that can be used by this server and that of what is configured on the remote deltaquest box this tunnel is for?"
read portidinput
echo $portidinput > /tmp/portid

# Rename the config file previously supplied the port and site ID
mv /u/tunnels/deltaquest-[siteid]-[port]-tunnel /u/tunnels/deltaquest-$(cat /tmp/addresscode)-$(cat /tmp/portid)-tunnel

#############################################

# get the stunnel-deltaquest.service file and place in /etc/systemd/system
/usr/bin/wget --no-check-certificate 'https://raw.githubusercontent.com/LoneFreeRanger/esp/main/pi/scripts/deltaquest_encryption/linux_server_end/stunnel-deltaquest.service' -O /etc/systemd/system/stunnel-deltaquest.service

# Set perms on the service file, load into kernel and enable on boot
chmod 777 /etc/systemd/system/stunnel-deltaquest.service
systemctl daemon-reload
systemctl enable stunnel-deltaquest.service



