
clear
echo "What is the address code for site?"
read addresscodeinput
echo $addresscodeinput > /tmp/addresscode
echo ""
echo "--------------------------------------------------"
echo ""
echo "What is the free deltaquest port number that can be used by this server?"
echo "This should be the port of what is configured on the remote deltaquest box this tunnel is for."
read portidinput
echo $portidinput > /tmp/portid
echo ""
echo "--------------------------------------------------"
echo ""
echo "What is the remote e-lite unit url?"
read eliteurlinput
echo $eliteurlinput > /tmp/e-liteurl
echo ""

PORTCHECK=$(lsof -i -P  | grep $(cat /tmp/portid) | wc -l)
CONFIGCHECK=$(cat /u/tunnels/deltaquest-* | grep $(cat /tmp/portid) | wc -l)
if [ $PORTCHECK -ge 1 ] || [ $CONFIGCHECK -ge 1 ]
then
clear
echo "The port you stated is already in use on this server and can't be used again"
echo ""
echo "or"
echo ""
echo "The port you stated is already present in config on the server."
echo ""
echo "No changes have been made. Please run this script again making sure the port ID is correct"
echo""
exit
else
clear
fi

############################

clear
echo ""
echo "Please confirm you wish for the new DeltQuest tunnel to be configured with the following:"
echo ""
echo "Site address code: $(cat /tmp/addresscode)"
echo ""
echo "DeltaQuest box and tunnel port number: $(cat /tmp/portid)"
echo ""
echo "e-Lite server URL: $(cat /tmp/e-liteurl)"
echo ""
echo "===================================================================="
echo ""
echo "Are all the above details correct? (n/y)"
read confirmdetails

if [ $confirmdetails == n ] || [ $confirmdetails == N ]
then
clear
echo ""
echo "Please run this script again and supply the correct details."
echo ""
echo "No changes have been made."
echo ""
echo "Good Bye."
exit
else
ping -c1 127.0.0.1 > /dev/null
fi

############################

# Get the default stunnel ESP config file
/usr/bin/wget --no-check-certificate 'https://raw.githubusercontent.com/LoneFreeRanger/esp/main/pi/scripts/deltaquest_encryption/linux_server_end/deltaquest-%5Bsiteid%5D-%5Bport%5D-tunnel' -O /u/tunnels/deltaquest-[siteid]-[port]-tunnel

# Update the port ID within the default config to be that of stated port ID supplied above
sed -i 's/portid/'$(cat /tmp/portid)'/g' /u/tunnels/deltaquest-[siteid]-[port]-tunnel

# Update the server url/ ip within the default config to be that of stated server url/ IP supplied above
sed -i 's/site_url/'$(cat /tmp/e-liteurl)'/g' /u/tunnels/deltaquest-[siteid]-[port]-tunnel

# Rename the config file with previously supplied port and site ID
mv /u/tunnels/deltaquest-[siteid]-[port]-tunnel /u/tunnels/deltaquest-$(cat /tmp/addresscode)-$(cat /tmp/portid)-tunnel

############################

# Get OS service file
/usr/bin/wget --no-check-certificate 'https://raw.githubusercontent.com/LoneFreeRanger/esp/main/pi/scripts/deltaquest_encryption/linux_server_end/stunnel-deltaquest-[siteid]-[portid].service' -O /etc/systemd/system/stunnel-deltaquest-[siteid]-[portid].service
chmod 777 /etc/systemd/system/stunnel-deltaquest-[siteid]-[portid].service

# Configure the OS service file port
sed -i 's/portid/'$(cat /tmp/portid)'/g' /etc/systemd/system/stunnel-deltaquest-[siteid]-[portid].service

# Configure the OS service file siteid
sed -i 's/siteid/'$(cat /tmp/siteid)'/g' /etc/systemd/system/stunnel-deltaquest-[siteid]-[portid].service

# Rename the default OS service file
mv /etc/systemd/system/stunnel-deltaquest-[siteid]-[portid].service /etc/systemd/system/stunnel-deltaquest-$(cat /tmp/siteid)-$(cat /tmp/portid).service

# Load the service into the kernel
systemctl daemon-reload
systemctl enable stunnel-deltaquest-$(cat /tmp/siteid)-$(cat /tmp/portid).service
systemctl start stunnel-deltaquest-$(cat /tmp/siteid)-$(cat /tmp/portid).service



