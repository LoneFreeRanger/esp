#####################
## Template script ##
#####################

# Check if script is being run as the root user
WHO=$(whoami)
if [ $WHO == root ]
then
sleep 0.5
else
echo "Please re-run this script as the root user. Bye!"
exit
fi

sudo /usr/bin/mkdir -p /u/pi/
sudo /usr/bin/mkdir -p /u/tmp
sudo /usr/bin/mkdir -p /u/espbin
sudo /usr/bin/touch /var/spool/cron/crontabs/root
sudo /usr/bin/chmod 600 /var/spool/cron/crontabs/root

# Update repos and install the packages required for ipps cups printing and support
sudo apt update -y
sudo apt-get install cups* -y
sudo apt-get install dnsutils -y
sudo apt-get install vim -y
sudo apt-get install arpwatch -y

# Make a sites user
sudo useradd -g50 -M -o -u201 -s /bin/bash -d /u/sites sites
sudo /usr/bin/mkdir -p /u/sites
sudo /usr/bin/mkdir -p /u/sites/esp-graphics

# Grant sites sudo privi
sudo /usr/sbin/adduser sites sudo

# Disable IPv6
sudo /usr/bin/echo "net.ipv6.conf.all.disable_ipv6=1" >> /etc/sysctl.conf

# Set a default password for sites and root. These will be updated per site basis later in prep stage
sudo /usr/bin/echo "sites:C7Hv!Z9Fsfx!kozs" | chpasswd
sudo /usr/bin/echo "root:gn3JA9K7G@7C8e.*" | chpasswd

# Download wallpaper and user icon graphics
sudo /usr/bin/wget --no-check-certificate 'https://raw.githubusercontent.com/LoneFreeRanger/esp/main/pi/misc/ESP_Wallpaper.png' -O /u/sites/esp-graphics/ESP_Wallpaper.png
sudo /usr/bin/wget --no-check-certificate 'https://raw.githubusercontent.com/LoneFreeRanger/esp/main/pi/misc/esp_jigsaw_logo.png' -O /u/sites/esp-graphics/ESP_Jigsaw_Logo.png

# Set the wallpaper and user log on icon for nicety
sudo /usr/bin/sed -i 's@default-user-image=.*@default-user-image=/u/sites/esp-graphics/ESP_Jigsaw_Logo.png@' /etc/lightdm/pi-greeter.conf
sudo /usr/bin/sed -i 's@wallpaper=.*@wallpaper=/u/sites/esp-graphics/ESP_Wallpaper.png@' /etc/lightdm/pi-greeter.conf

# Disable the bluetooth service
sudo systemctl disable bluetooth.service

# Disable wi-fi
sudo /usr/bin/echo "# Disable wireless services" >> /boot/config.txt
sudo /usr/bin/echo "dtoverlay=pi3-disable-wifi" >> /boot/config.txt
sudo /usr/bin/echo "dtoverlay=pi3-disable-bt" >> /boot/config.txt

# THE FOLLOWING BITS ARE NOW DISABLED AS CAUSED BOOT ISSUES WHEN PI WAS PATCHED UP LATER ON
# Minimise the boot process (remove graphics etc.) - a recent update seems to break this and prevent the pi from booting hence now disabled.
#awk '{print $0" quiet"}' /boot/cmdline.txt > /boot/cmdline.txtNEW && mv /boot/cmdline.txtNEW /boot/cmdline.txt
# Removes Raspberry Pi logo in top left corner on boot - a recent update seems to break this and prevent the pi from booting hence now disabled.
#awk '{print $0" logo.nologo"}' /boot/cmdline.txt > /boot/cmdline.txtNEW && mv /boot/cmdline.txtNEW /boot/cmdline.txt
# Remove Raspberry Pi splash screen - a recent update seems to break this and prevent the pi from booting hence now disabled.
#sed 's/splash//g' /boot/cmdline.txt > /boot/cmdline.txtNEW && mv /boot/cmdline.txtNEW /boot/cmdline.txt

# Disable USB drives from being auto-mounted
sudo /usr/bin/sed -i 's/.*mount_on_startup=1.*/mount_on_startup=0/g' /etc/xdg/pcmanfm/default/pcmanfm.conf
sudo /usr/bin/sed -i 's/.*mount_removable=1.*/mount_removable=0/g' /etc/xdg/pcmanfm/default/pcmanfm.conf
sudo /usr/bin/sed -i 's/.*autorun=1.*/autorun=0/g' /etc/xdg/pcmanfm/default/pcmanfm.conf
sudo /usr/bin/sed -i 's/.*mount_on_startup=1.*/mount_on_startup=0/g' /etc/xdg/pcmanfm/LXDE-pi/pcmanfm.conf
sudo /usr/bin/sed -i 's/.*mount_removable=1.*/mount_removable=0/g' /etc/xdg/pcmanfm/LXDE-pi/pcmanfm.conf
sudo /usr/bin/sed -i 's/.*autorun=1.*/autorun=0/g' /etc/xdg/pcmanfm/LXDE-pi/pcmanfm.conf

# Disable the pi user being auto logged in (gui) - user will be removed later
sudo /usr/bin/sed -i 's/.*autologin-user=pi.*/#autologin-user=pi/g' /etc/lightdm/lightdm.conf

# Disable the pi user being auto logged in under tty1 (cli) - user will be removed later
sudo systemctl disable getty@tty1.service

# Change default Pi user password
#echo "pi:ne0sKmSVDw4OlR4mX9RO0yM2ZFtWv" | chpasswd

# Lock the pi user account from being able to login.
#passwd -l pi

# Prevent the gui screen from showing the list of available users
sudo /usr/bin/sed -i 's/greeter-hide-users=false/greeter-hide-users=true/g' /etc/lightdm/lightdm.conf

# Disable avahi-daemon to prevent pi from being auto-discovered on the network
sudo systemctl stop avahi-daemon
sudo systemctl disable avahi-daemon
sudo apt-get remove avahi-daemon -y

# Install the no-ip client to /u/noip
sudo /usr/bin/mkdir -p /u/noip
sudo cd /u/noip
sudo /usr/bin/wget http://www.no-ip.com/client/linux/noip-duc-linux.tar.gz
sudo tar vzxf noip-duc-linux.tar.gz
sudo rm -rf noip-duc-linux.tar.gz
sudo cd noip*
sudo mv * ../
sudo cd ../
sudo make
sudo rm -rf /u/noip/noip-*
sudo clear

# Change the Pi's default hostname to esp (this will be updated later to be applicable to site)
sudo /usr/bin/sed -i 's/raspberrypi/esp/g' /etc/hosts
sudo hostnamectl set-hostname esp

# Change default ssh port 22 to port 60022
sudo /usr/bin/sed -i 's/.*#Port 22.*/Port 60022/g' /etc/ssh/sshd_config

# Drop idle ssh sessions after 6 minutes of inactivity
sudo /usr/bin/sed -i 's/.*ClientAliveInterval.*/ClientAliveInterval 360/g' /etc/ssh/sshd_config
sudo /usr/bin/sed -i 's/.*ClientAliveCountMax.*/ClientAliveCountMax 0/g' /etc/ssh/sshd_config

# Don't permit root ssh access
sudo /usr/bin/sed -i 's/.*PermitRootLogin.*/PermitRootLogin no/g' /etc/ssh/sshd_config

# Don't permit empty ssh passwords
sudo /usr/bin/sed -i 's/.*PermitEmptyPasswords.*/PermitEmptyPasswords no/g' /etc/ssh/sshd_config

# Only permit the sites and pi user ssh access
sudo /usr/bin/echo "AllowUsers sites pi" >> /etc/ssh/sshd_config

# Deny soon to be non-existent pi user ssh access - user will be removed later in prep
sudo /usr/bin/echo "DenyUsers pi" >> /etc/ssh/sshd_config

# Only permit stronger ssh protocol version 2
sudo /usr/bin/echo "Protocol 2" >> /etc/ssh/sshd_config

# Drop failed ssh connection after 3 attempts
sudo /usr/bin/sed -i 's/.*MaxAuthTries.*/MaxAuthTries 3/g' /etc/ssh/sshd_config

# Disable X11 over ssh
sudo /usr/bin/sed -i 's/.*X11Forwarding yes.*/X11Forwarding no/g' /etc/ssh/sshd_config

# Set-up firewall
sudo /usr/bin/wget --no-check-certificate 'https://raw.githubusercontent.com/LoneFreeRanger/esp/main/pi/iptables/iptables.firewall.rules' -O /etc/iptables.firewall.rules

# Configure rc.local to load firewall rules  and noip client on boot
sudo /usr/bin/sed -i '19 i /u/noip/noip2' /etc/rc.local
sudo /usr/bin/sed -i '20 i /sbin/iptables-restore < /etc/iptables.firewall.rules' /etc/rc.local

# Download and install pre-configured ESP CUPS config file
sudo /usr/bin/wget --no-check-certificate 'https://raw.githubusercontent.com/LoneFreeRanger/esp/main/pi/cups/cupsd.conf' -O /etc/cups/cupsd.conf

# Remove contents of issue.net in order to hide OS login prompt detail (CLI)
sudo >/etc/issue.net
sudo >/etc/issue
sudo >/etc/motd

# Add scary message at login
sudo /usr/bin/echo "###############################################################" >>/etc/motd
sudo /usr/bin/echo "#                 Authorized access only                      #" >>/etc/motd
sudo /usr/bin/echo "#  Disconnect IMMEDIATELY if you are not an authorised user.  #" >>/etc/motd
sudo /usr/bin/echo "#         All actions are monitored and logged.               #" >>/etc/motd
sudo /usr/bin/echo "###############################################################" >>/etc/motd

# Install monit
sudo apt install -y monit
sudo touch /etc/monit.credentials
sudo touch /etc/monit.raspberrypi
sudo /usr/bin/echo "set mmonit https://USERNAME:PASSWORD@mmonit.esp-support.co.uk:62814/collector" > /etc/monit.credentials
sudo /usr/bin/echo "include /etc/monit.credentials" >> /etc/monit/monitrc
sudo /usr/bin/echo "include /etc/monit.raspberrypi" >> /etc/monit/monitrc
sudo /usr/bin/sed -i 's/set daemon 120/set daemon 60/g' /etc/monit/monitrc
sudo service monit restart
sudo systemctl enable monit
sudo /usr/bin/wget --no-check-certificate 'https://raw.githubusercontent.com/LoneFreeRanger/esp/main/pi/monit/espmonitoring-pi' -O /u/espbin/espmonitoring-pi
sudo /usr/bin/chmod 777 /u/espbin/espmonitoring-pi
sudo /usr/bin/echo "*/1 * * * * /u/espbin/espmonitoring-pi" >> /var/spool/cron/crontabs/root
sudo /usr/bin/wget --no-check-certificate 'https://raw.githubusercontent.com/LoneFreeRanger/esp/main/pi/monit/monit.raspberrypi' -O /etc/monit.raspberrypi

# Install ClamAV
sudo /usr/bin/mkdir -p /u/logs/av
sudo /usr/bin/mkdir -p /u/espbin
sudo touch /u/logs/av/avscanresult
sudo apt install -y clamav
sudo systemctl disable clamav-freshclam.service
sudo /usr/bin/wget --no-check-certificate 'https://raw.githubusercontent.com/LoneFreeRanger/esp/main/pi/av/espav-pi' -O /u/espbin/espav-pi
sudo /usr/bin/chmod 777 /u/espbin/espav-pi
sudo /usr/bin/echo "30 02 * * * /u/espbin/espav-pi" >> /var/spool/cron/crontabs/root

# Increase the default swap memory size of the raspberry Pi to be 2Gb
sudo dphys-swapfile swapoff
sudo /usr/bin/sed -i 's/CONF_SWAPSIZE=100/CONF_SWAPSIZE=2048/g' /etc/dphys-swapfile
sudo dphys-swapfile setup
sudo dphys-swapfile swapon

# Ensure fsck is done on next boot when the file system checker deems necessary
# Auto select 'yes' to prompts (fsck.repair=yes) is already enabled out of the box
sudo /usr/bin/sed -i s/$/\ fsck.mode=auto/ /boot/cmdline.txt

# Put in place site setup script
sudo /usr/bin/wget --no-check-certificate 'https://raw.githubusercontent.com/LoneFreeRanger/esp/main/pi/scripts/pi_site_setup' -O /u/espbin/pi_site_setup
sudo /usr/bin/chmod 777 /u/espbin/pi_site_setup

# Reboot
sudo clear
sudo /usr/bin/echo ""
sudo read -p "Please press enter to reboot the pi...."
sudo reboot
